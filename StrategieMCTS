import java.util.ArrayList;
import java.util.List;
import java.util.Random;

public class MCTSNode {

    private AwaleState state;
    private MCTSNode parent;
    private List<MCTSNode> children;
    private int visits;
    private double wins;
    private int moveFromParent;

    private static Random rand = new Random();

    public MCTSNode(AwaleState state, MCTSNode parent, int moveFromParent) {
        this.state = state;
        this.parent = parent;
        this.moveFromParent = moveFromParent;
        this.children = new ArrayList<>();
        this.visits = 0;
        this.wins = 0;
    }

    public boolean isFullyExpanded() {
        return children.size() == state.getValidMoves().size();
    }

    public boolean isTerminal() {
        return state.isTerminal();
    }

    public MCTSNode selectChild() {
        MCTSNode best = null;
        double bestValue = Double.NEGATIVE_INFINITY;

        for (MCTSNode child : children) {
            double uct = child.wins / (child.visits + 1e-6) +
                    Math.sqrt(2 * Math.log(this.visits + 1) / (child.visits + 1e-6));
            if (uct > bestValue) {
                bestValue = uct;
                best = child;
            }
        }

        return best;
    }

    public MCTSNode expand() {
        List<Integer> possibleMoves = state.getValidMoves();

        for (int move : possibleMoves) {
            boolean alreadyExpanded = false;
            for (MCTSNode c : children) {
                if (c.moveFromParent == move) {
                    alreadyExpanded = true;
                    break;
                }
            }

            if (!alreadyExpanded) {
                AwaleState next = state.playMove(move);
                MCTSNode childNode = new MCTSNode(next, this, move);
                children.add(childNode);
                return childNode;
            }
        }
        return null; // tous les enfants déjà créés
    }

    public void backpropagate(double result) {
        visits++;
        wins += result;
        if (parent != null) parent.backpropagate(result);
    }

    public AwaleState getState() { return state; }
    public int getMoveFromParent() { return moveFromParent; }
    public List<MCTSNode> getChildren() { return children; }
    public int getVisits() { return visits; }
    public double getWins() { return wins; }
}

